<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Panorama Viewer</title>
    <script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.min.js"></script>
    <!-- Pannellum CSS -->
    <link rel="stylesheet" href="lib/Pannellum2_5_6/pannellum.css"/>
    <!-- Pannellum JS -->
    <script type="text/javascript" src="lib/Pannellum2_5_6/pannellum.js"></script>
    <script type="text/javascript" src="lib/Pannellum2_5_6/libpannellum.js"></script>
    <style>
        /* Добавляем стили для полноэкранного отображения */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
    </style>
</head>
<body>
<div id="canvas"></div>
<script>
    var sceneMain = null;
    var currentScene = null;
    $(document).ready(function() {
        loadInitialScene();
    });

    function loadInitialScene() {
        setSelectPanorama();
    }
    function setSelectPanorama(hotSpot) {
        let params = new URLSearchParams(document.location.search);
        let infoValue = params.get('info');
        let photoValue = params.get('photo');
        let canvas = document.getElementById('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        if (photoValue) {
            var imageUrl = photoValue;
            var isExternal = /^https?:\/\//i.test(photoValue);
            if (isExternal) {
                var tempIframe = document.createElement('iframe');
                tempIframe.style.display = 'none';
                tempIframe.style.width = '0';
                tempIframe.style.height = '0';
                tempIframe.style.border = '0';
                tempIframe.style.position = 'absolute';
                tempIframe.style.top = '-1000px';
                tempIframe.style.left = '-1000px';
                // Добавляем iframe в DOM, но НЕ устанавливаем src сразу
                document.body.appendChild(tempIframe);
                // Устанавливаем src через небольшой таймаут
                setTimeout(function() {
                    tempIframe.src = photoValue;
                    // Удаляем iframe через 10 секунд чтобы не засорять DOM
                    setTimeout(function() {
                        if (tempIframe && tempIframe.parentNode) {
                            tempIframe.parentNode.removeChild(tempIframe);
                        }
                    }, 10000);
                }, 100);
                imageUrl = photoValue;
            }
            let jsonObj = {
                "hotSpotDebug": false,
                "hotPointDebug": true,
                "sceneFadeDuration": 1000,
                "default": {
                    "firstScene": "scene1"
                },
                "scenes": {
                    "scene1": {
                        "title": isExternal ? "External Image" : "Image: " + photoValue,
                        "panorama": imageUrl,
                        "crossOrigin": isExternal ? undefined : "use-credentials",
                        "autoLoad": true,
                        "yaw": 0,
                        "pitch": 0,
                        "hotSpots": []
                    }
                }
            };
            // Дополнительные настройки для внешних изображений
            if (isExternal) {
                // Убеждаемся, что URL начинается с https://
                var secureUrl = photoValue;
                if (secureUrl.startsWith('http://')) {
                    secureUrl = secureUrl.replace('http://', 'https://');
                }

                // Создаем временный iframe для предзагрузки изображения
                var tempIframe = document.createElement('iframe');
                tempIframe.style.display = 'none';
                tempIframe.style.width = '0';
                tempIframe.style.height = '0';
                tempIframe.style.border = '0';
                tempIframe.style.position = 'absolute';
                tempIframe.style.top = '-1000px';
                tempIframe.style.left = '-1000px';

                // Устанавливаем атрибут sandbox для безопасности
                tempIframe.sandbox = 'allow-same-origin allow-scripts';

                // Добавляем iframe в DOM
                document.body.appendChild(tempIframe);

                // Загружаем через HTTPS с небольшим таймаутом
                setTimeout(function() {
                    tempIframe.src = secureUrl;
                    console.log('Preloading external image via iframe:', secureUrl);
                    // Удаляем iframe через 10 секунд чтобы не засорять DOM
                    setTimeout(function() {
                        if (tempIframe && tempIframe.parentNode) {
                            tempIframe.parentNode.removeChild(tempIframe);
                            console.log('Cleanup: iframe removed');
                        }
                    }, 10000);
                }, 100);
                imageUrl = photoValue; // Оставляем оригинальный URL для Pannellum
            }
            jsonObj.onClickHotSpot = onClickHotSpot;
            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = photoValue;
        }
        // Если есть параметр info, загружаем через JSON конфигурацию
        else if (infoValue) {
            let jsonObj = getJsonUrlData('/Example/pano360/point_info/' + infoValue);
            jsonObj.onClickHotSpot = onClickHotSpot;

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = infoValue;
        }
        // Если нет параметров, загружаем изображение по умолчанию
        else {
            // Веб-путь для изображения по умолчанию
            var defaultImage = 'img/04.01.2026/DSCN0021.JPG';

            let jsonObj = {
                "hotSpotDebug": false,
                "hotPointDebug": true,
                "sceneFadeDuration": 1000,
                "default": {
                    "firstScene": "scene1"
                },
                "scenes": {
                    "scene1": {
                        "title": "Default Panorama",
                        "panorama": defaultImage,
                        "crossOrigin": "use-credentials",
                        "autoLoad": true,
                        "yaw": -6.77,
                        "pitch": -24.41,
                        "hotSpots": []
                    }
                }
            };
            jsonObj.onClickHotSpot = onClickHotSpot;
            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = 'default';
        }
    }

    function onClickHotSpot(hs) {
        const jsonName = hs['panorama_url']?.split('/')[4];
        if (jsonName) {
            const name = jsonName.split('.')[0];
            let currentUrl = new URL(window.location.href);
            if (!currentUrl.searchParams.get('info')) {
                currentUrl.searchParams.append('info', hs.panorama_url.split('/')[4]);
            } else {
                currentUrl.searchParams.set('info', hs.panorama_url.split('/')[4]);
            }
            window.history.pushState({}, '', currentUrl);
            let jsonObj = getJsonUrlData(hs['panorama_url']);
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj['pitch'] = hs['point_pitch'];
            jsonObj['yaw'] = hs['point_yaw'];
            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = name;
            return true;
        }
        return false;
    }
    // Вспомогательные функции
    function getJsonUrlData(url, data) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, false);
        xhr.send(data);
        if (xhr.status != 200) {
            console.error(xhr.status + ': ' + xhr.statusText + ' (' + url + ')');
            return {'error': xhr.status + ' : ' + xhr.statusText};
        } else {
            return JSON.parse(xhr.response);
        }
    }
</script>
</body>
</html>