<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Panorama Viewer</title>
    <!-- Pannellum CSS -->
    <link rel="stylesheet" href="lib/Pannellum2_5_6/pannellum.css"/>
    <!-- Pannellum JS -->
    <script type="text/javascript" src="lib/Pannellum2_5_6/pannellum.js"></script>
    <script type="text/javascript" src="lib/Pannellum2_5_6/libpannellum.js"></script>
    <style>
        /* Добавляем стили для полноэкранного отображения */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
    </style>
</head>
<body>
<div id="canvas"></div>
<script>
    var sceneMain = null;
    var currentScene = null;

    // Заменяем $(document).ready() на DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        loadInitialScene();
    });

    function loadInitialScene() {
        setSelectPanorama();
    }
    // [{"pitch": -10,"yaw": 30,"type": "scene","text": "Перейти к следующей сцене","panorama_url": "https://raw.githubusercontent.com/MyasnikovIA/Pano360/main/img/04.01.2026/DSCN0033.JPG","point_pitch": 0,"point_yaw": 0},{"pitch": 5,"yaw": -45,"type": "info","text": "Информация о точке","panorama_url": "https://raw.githubusercontent.com/MyasnikovIA/Pano360/main/img/04.01.2026/DSCN0137.JPG","point_pitch": 10,"point_yaw": 20}]
    async function setSelectPanorama(hotSpot) {
        let params = new URLSearchParams(document.location.search);
        let infoValue = params.get('info');
        let photoValue = params.get('photo');
        let hotSpots = params.get('hotSpots');
        let canvas = document.getElementById('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '100%';

        if (photoValue) {
            var imageUrl = photoValue;
            var isExternal = /^https?:\/\//i.test(photoValue);

            // Для внешних изображений пробуем загрузить JSON с горячими точками
            var hotspotsFromJson = [];
            if (isExternal) {
                // Создаем URL для JSON файла
                var jsonUrl = photoValue.replace(/\.[^/.]+$/, "") + ".json";

                // Пробуем загрузить JSON
                try {
                    hotspotsFromJson = await loadHotSpotsFromJson(jsonUrl);
                    console.log("Loaded hotspots from JSON:", hotspotsFromJson);
                } catch (error) {
                    console.log("No JSON file found or error loading:", jsonUrl);
                }

                // Также добавляем iframe для предзагрузки изображения
                var tempIframe = document.createElement('iframe');
                tempIframe.style.display = 'none';
                tempIframe.style.width = '0';
                tempIframe.style.height = '0';
                tempIframe.style.border = '0';
                tempIframe.style.position = 'absolute';
                tempIframe.style.top = '-1000px';
                tempIframe.style.left = '-1000px';
                document.body.appendChild(tempIframe);

                setTimeout(function() {
                    tempIframe.src = photoValue;
                    setTimeout(function() {
                        if (tempIframe && tempIframe.parentNode) {
                            tempIframe.parentNode.removeChild(tempIframe);
                        }
                    }, 10000);
                }, 100);
            }

            // Если есть hotspots в URL параметре, парсим их
            var hotspotsArray = [];
            if (hotSpots) {
                try {
                    hotspotsArray = JSON.parse(hotSpots);
                } catch (e) {
                    console.error("Error parsing hotSpots URL parameter:", e);
                }
            }

            // Объединяем hotspots из JSON и URL параметра
            var allHotSpots = [...hotspotsFromJson, ...hotspotsArray];

            let jsonObj = {
                "hotSpotDebug": false,
                "hotPointDebug": true,
                "sceneFadeDuration": 1000,
                "default": {
                    "firstScene": "scene1"
                },
                "scenes": {
                    "scene1": {
                        "title": "",
                        "panorama": imageUrl,
                        "crossOrigin": isExternal ? undefined : "use-credentials",
                        "autoLoad": true,
                        // Устанавливаем направление взгляда из hotSpot, если передано
                        "yaw": (hotSpot && hotSpot.point_yaw !== undefined) ? hotSpot.point_yaw : 0,
                        "pitch": (hotSpot && hotSpot.point_pitch !== undefined) ? hotSpot.point_pitch : 0,
                        "hotSpots": allHotSpots.length > 0 ? allHotSpots : []
                    }
                }
            };

            // Добавляем обработчик для перехода по hotspots
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = onDblClick;
            jsonObj.onClick = onClick;
            jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
            jsonObj.onContextMenu = onContextMenu;

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = photoValue;
        }
        // Если есть параметр info, загружаем через JSON конфигурацию
        else if (infoValue) {
            let jsonObj = getJsonUrlData('/Example/pano360/point_info/' + infoValue);
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = onDblClick;
            jsonObj.onClick = onClick;
            jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
            jsonObj.onContextMenu = onContextMenu;

            // Устанавливаем направление взгляда из hotSpot, если передано
            if (hotSpot) {
                if (hotSpot.point_pitch !== undefined && jsonObj.scenes && jsonObj.scenes.scene1) {
                    jsonObj.scenes.scene1.pitch = hotSpot.point_pitch;
                }
                if (hotSpot.point_yaw !== undefined && jsonObj.scenes && jsonObj.scenes.scene1) {
                    jsonObj.scenes.scene1.yaw = hotSpot.point_yaw;
                }
            }

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = infoValue;
        }
        // Если нет параметров, загружаем изображение по умолчанию
        else {
            var defaultImage = 'img/04.01.2026/DSCN0021.JPG';

            let jsonObj = {
                "hotSpotDebug": false,
                "hotPointDebug": true,
                "sceneFadeDuration": 1000,
                "default": {
                    "firstScene": "scene1"
                },
                "scenes": {
                    "scene1": {
                        "title": "Default Panorama",
                        "panorama": defaultImage,
                        "crossOrigin": "use-credentials",
                        "autoLoad": true,
                        "yaw": (hotSpot && hotSpot.point_yaw !== undefined) ? hotSpot.point_yaw : -6.77,
                        "pitch": (hotSpot && hotSpot.point_pitch !== undefined) ? hotSpot.point_pitch : -24.41,
                        "hotSpots": []
                    }
                }
            };
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = onDblClick;
            jsonObj.onClick = onClick;
            jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
            jsonObj.onContextMenu = onContextMenu;

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = 'default';
        }
    }

    // Функция для загрузки hotspots из JSON файла
    async function loadHotSpotsFromJson(jsonUrl) {
        try {
            const response = await fetch(jsonUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const hotspots = await response.json();

            // Проверяем, является ли результат массивом
            if (Array.isArray(hotspots)) {
                return hotspots;
            } else if (hotspots.hotSpots && Array.isArray(hotspots.hotSpots)) {
                return hotspots.hotSpots;
            } else if (hotspots.scenes && hotspots.scenes.scene1 && hotspots.scenes.scene1.hotSpots) {
                return hotspots.scenes.scene1.hotSpots;
            }

            return [];
        } catch (error) {
            console.log("Error loading JSON hotspots:", error);
            return [];
        }
    }

    function onDblClick(hs) {
        console.log("onClick", arguments[0]);
    }

    function onClick(hs) {
        console.log("onClick", arguments[0]);
    }

    function onClickHotSpot(hs) {
        console.log("onClickHotSpot", hs);

        // Проверяем, есть ли URL для загрузки новой сцены
        if (hs.panorama_url) {
            // Обновляем URL страницы с новыми параметрами
            let currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('photo', hs.panorama_url);
            currentUrl.searchParams.delete('hotSpots');
            window.history.pushState({}, '', currentUrl);

            // Загружаем новую сцену
            setSelectPanorama(hs);
            return true;
        }

        // Старая логика для JSON конфигураций
        const jsonName = hs['panorama_url']?.split('/')[4];
        if (jsonName) {
            const name = jsonName.split('.')[0];
            let currentUrl = new URL(window.location.href);
            if (!currentUrl.searchParams.get('info')) {
                currentUrl.searchParams.append('info', hs.panorama_url.split('/')[4]);
            } else {
                currentUrl.searchParams.set('info', hs.panorama_url.split('/')[4]);
            }
            currentUrl.searchParams.delete('hotSpots');
            window.history.pushState({}, '', currentUrl);
            let jsonObj = getJsonUrlData(hs['panorama_url']);
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = onDblClick;
            jsonObj.onClick = onClick;
            jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
            jsonObj.onContextMenu = onContextMenu;

            jsonObj['pitch'] = hs['point_pitch'];
            jsonObj['yaw'] = hs['point_yaw'];
            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = name;
            return true;
        }
        return false;
    }

    // Вспомогательные функции
    function getJsonUrlData(url, data) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, false);
        xhr.send(data);
        if (xhr.status != 200) {
            console.error(xhr.status + ': ' + xhr.statusText + ' (' + url + ')');
            return {'error': xhr.status + ' : ' + xhr.statusText};
        } else {
            return JSON.parse(xhr.response);
        }
    }

    // Функция для обработки правой кнопки мыши на HotSpot
    function onContextMenuHotSpot(coords, screenCoords, event, hotSpot) {
        console.log("Right click on HotSpot:", {
            coords: coords,
            screenCoords: screenCoords,
            hotSpot: hotSpot,
            event: event
        });

        showCustomContextMenu(screenCoords.x, screenCoords.y, {
            type: 'hotspot',
            data: hotSpot,
            coords: coords
        });
    }

    // Функция для обработки правой кнопки мыши на сцене
    function onContextMenu(coords, screenCoords, event) {
        console.log("Right click on scene:", {
            coords: coords,
            screenCoords: screenCoords,
            event: event
        });
        showCustomContextMenu(screenCoords.x, screenCoords.y, {
            type: 'scene',
            data: coords,
            screenCoords: screenCoords
        });
    }

    // Вспомогательная функция для показа кастомного контекстного меню
    function showCustomContextMenu(x, y, data) {
        var oldMenu = document.getElementById('custom-context-menu');
        if (oldMenu) {
            oldMenu.remove();
        }

        var menu = document.createElement('div');
        menu.id = 'custom-context-menu';
        menu.style.position = 'absolute';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.style.background = 'white';
        menu.style.border = '1px solid #ccc';
        menu.style.boxShadow = '2px 2px 5px rgba(0,0,0,0.2)';
        menu.style.zIndex = '10000';
        menu.style.padding = '5px 0';
        menu.style.minWidth = '150px';

        if (data.type === 'hotspot') {
            menu.innerHTML = `
            <div class="menu-item" onclick="handleHotSpotAction('edit', ${JSON.stringify(data.data).replace(/"/g, '&quot;')})" style="padding: 5px 10px; cursor: pointer;">Edit HotSpot</div>
            <div class="menu-item" onclick="handleHotSpotAction('delete', ${JSON.stringify(data.data).replace(/"/g, '&quot;')})" style="padding: 5px 10px; cursor: pointer;">Delete HotSpot</div>
            <hr style="margin: 5px 0;">
            <div class="menu-item" onclick="copyCoords(${JSON.stringify(data.coords)})" style="padding: 5px 10px; cursor: pointer;">Copy Coordinates</div>
        `;
        } else {
            menu.innerHTML = `
            <div class="menu-item" onclick='addHotSpotAt(${JSON.stringify(data.data)})' style="padding: 5px 10px; cursor: pointer;">Add HotSpot Here</div>
            <div class="menu-item" onclick='copyCoords(${JSON.stringify(data.data)})' style="padding: 5px 10px; cursor: pointer;">Copy Coordinates</div>
            <hr style="margin: 5px 0;">
            <div class="menu-item" onclick='centerView(${JSON.stringify(data.data)})' style="padding: 5px 10px; cursor: pointer;">Center View Here</div>
        `;
        }

        document.body.appendChild(menu);

        setTimeout(function() {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    // Пример обработчиков действий меню
    function handleHotSpotAction(action, hotSpot) {
        console.log(action + ' HotSpot:', hotSpot);
        alert(action + ' HotSpot: ' + (hotSpot.text || hotSpot.type));
    }

    function copyCoords(coords) {
        var text = `Yaw: ${coords.yaw.toFixed(2)}, Pitch: ${coords.pitch.toFixed(2)}`;
        navigator.clipboard.writeText(text).then(function() {
            console.log('Coordinates copied to clipboard:', text);
            alert('Coordinates copied: ' + text);
        });
    }

    function addHotSpotAt(coords) {
        console.log('Add HotSpot at:', coords);
        alert('Add HotSpot at: Yaw=' + coords.yaw.toFixed(2) + ', Pitch=' + coords.pitch.toFixed(2));
    }

    function centerView(coords) {
        if (sceneMain) {
            sceneMain.lookAt(coords.pitch, coords.yaw, sceneMain.getHfov(), 500);
        }
    }

</script>
</body>
</html>