<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Panorama Viewer</title>
    <!-- Pannellum CSS -->
    <link rel="stylesheet" href="lib/Pannellum2_5_6/pannellum.css"/>
    <!-- Pannellum JS -->
    <script type="text/javascript" src="lib/Pannellum2_5_6/pannellum.js"></script>
    <script type="text/javascript" src="lib/Pannellum2_5_6/libpannellum.js"></script>
    <style>
        /* Добавляем стили для полноэкранного отображения */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Стили для iframe информации */
        .iframe-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 10001;
            max-width: 300px;
            display: none;
            border: 1px solid #555;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .iframe-info h3 {
            margin: 0 0 8px 0;
            color: #4CAF50;
            font-size: 14px;
        }

        .iframe-info .attr {
            margin: 3px 0;
            font-family: monospace;
            font-size: 11px;
            color: #ddd;
        }

        .iframe-info .toggle-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 10px;
        }

        /* Оптимизация для iframe */
        body.iframe-mode .pnlm-about-msg {
            display: none !important;
        }

        /* Отключаем выделение текста для лучшей производительности */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
<div id="canvas"></div>

<!-- Блок информации об iframe атрибутах -->
<div id="iframeInfo" class="iframe-info">
    <button class="toggle-btn" onclick="toggleIframeInfo()">×</button>
    <h3>IFrame Attributes</h3>
    <div id="iframeAttributes"></div>
</div>

<script>
    var sceneMain = null;
    var currentScene = null;
    var isInIframe = window.self !== window.top;
    var iframeInfoVisible = false;

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
        // Если страница в iframe, добавляем класс для стилей
        if (isInIframe) {
            document.body.classList.add('iframe-mode');
            // Показываем информацию об iframe атрибутах
            setTimeout(showIframeAttributes, 500);
        }

        // Предотвращаем стандартное контекстное меню на всей странице
        document.addEventListener('contextmenu', function(e) {
            if (!e.target.closest('#iframeInfo')) {
                e.preventDefault();
            }
        });

        loadInitialScene();
    });

    // Функция для показа атрибутов iframe
    function showIframeAttributes() {
        if (!isInIframe) return;

        try {
            var iframes = window.parent.document.getElementsByTagName('iframe');
            var currentIframe = null;

            // Находим текущий iframe
            for (var i = 0; i < iframes.length; i++) {
                try {
                    if (iframes[i].contentWindow === window) {
                        currentIframe = iframes[i];
                        break;
                    }
                } catch(e) {
                    // Игнорируем ошибки безопасности
                }
            }

            if (currentIframe) {
                var attrs = currentIframe.attributes;
                var attrHtml = '';

                for (var j = 0; j < attrs.length; j++) {
                    var attr = attrs[j];
                    attrHtml += '<div class="attr"><strong>' + attr.name + ':</strong> ' +
                        (attr.value || 'true') + '</div>';
                }

                document.getElementById('iframeAttributes').innerHTML = attrHtml;
                document.getElementById('iframeInfo').style.display = 'block';
                iframeInfoVisible = true;
            }
        } catch(e) {
            console.log('Cannot access iframe attributes due to security restrictions');
        }
    }

    // Функция для переключения видимости информации об iframe
    function toggleIframeInfo() {
        var infoDiv = document.getElementById('iframeInfo');
        iframeInfoVisible = !iframeInfoVisible;
        infoDiv.style.display = iframeInfoVisible ? 'block' : 'none';
    }

    // Глобальная функция для скрытия iframe информации (может быть вызвана из родительской страницы)
    window.hideIframeInfo = function() {
        document.getElementById('iframeInfo').style.display = 'none';
        iframeInfoVisible = false;
    };

    // Глобальная функция для показа iframe информации
    window.showIframeInfo = function() {
        if (isInIframe) {
            document.getElementById('iframeInfo').style.display = 'block';
            iframeInfoVisible = true;
        }
    };

    function loadInitialScene() {
        setSelectPanorama();
    }

    async function setSelectPanorama(hotSpot) {
        let params = new URLSearchParams(document.location.search);
        let infoValue = params.get('info');
        let photoValue = params.get('photo');
        let hotSpots = params.get('hotSpots');
        let canvas = document.getElementById('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '100%';

        if (photoValue) {
            var imageUrl = photoValue;
            var isExternal = /^https?:\/\//i.test(photoValue);

            // Для внешних изображений пробуем загрузить JSON с горячими точками
            var hotspotsFromJson = [];
            if (isExternal) {
                // Создаем URL для JSON файла
                var jsonUrl = photoValue.replace(/\.[^/.]+$/, "") + ".json";

                // Пробуем загрузить JSON
                try {
                    hotspotsFromJson = await loadHotSpotsFromJson(jsonUrl);
                    console.log("Loaded hotspots from JSON:", hotspotsFromJson);
                } catch (error) {
                    console.log("No JSON file found or error loading:", jsonUrl);
                }

                // Предзагрузка изображения для iframe (упрощенная версия)
                if (isInIframe) {
                    var imgPreload = new Image();
                    imgPreload.src = photoValue;
                    imgPreload.onload = function() {
                        console.log("Image preloaded for iframe");
                    };
                }
            }

            // Если есть hotspots в URL параметре, парсим их
            var hotspotsArray = [];
            if (hotSpots) {
                try {
                    hotspotsArray = JSON.parse(decodeURIComponent(hotSpots));
                } catch (e) {
                    console.error("Error parsing hotSpots URL parameter:", e);
                }
            }

            // Объединяем hotspots из JSON и URL параметра
            var allHotSpots = [...hotspotsFromJson, ...hotspotsArray];

            let jsonObj = {
                "hotSpotDebug": false,
                "hotPointDebug": false, // Отключаем для производительности в iframe
                "sceneFadeDuration": isInIframe ? 500 : 1000, // Уменьшаем длительность в iframe
                "default": {
                    "firstScene": "scene1"
                },
                "scenes": {
                    "scene1": {
                        "title": "",
                        "panorama": imageUrl,
                        "crossOrigin": isExternal ? undefined : "use-credentials",
                        "autoLoad": true,
                        // Устанавливаем направление взгляда из hotSpot, если передано
                        "yaw": (hotSpot && hotSpot.point_yaw !== undefined) ? hotSpot.point_yaw : 0,
                        "pitch": (hotSpot && hotSpot.point_pitch !== undefined) ? hotSpot.point_pitch : 0,
                        "hotSpots": allHotSpots.length > 0 ? allHotSpots : []
                    }
                }
            };

            // Добавляем обработчики событий
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = isInIframe ? null : onDblClick; // Отключаем двойной клик в iframe
            jsonObj.onClick = onClick;

            // Отключаем контекстное меню в iframe режиме
            if (!isInIframe) {
                jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
                jsonObj.onContextMenu = onContextMenu;
            }

            // Оптимизация для iframe: уменьшаем качество если в iframe
            if (isInIframe) {
                jsonObj.multiResMinHfov = true;
                if (jsonObj.scenes && jsonObj.scenes.scene1) {
                    jsonObj.scenes.scene1.maxHfov = 120;
                    jsonObj.scenes.scene1.minHfov = 30;
                }
            }

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = photoValue;
        }
        // Если есть параметр info, загружаем через JSON конфигурацию
        else if (infoValue) {
            let jsonObj = getJsonUrlData('/Example/pano360/point_info/' + infoValue);
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = isInIframe ? null : onDblClick;
            jsonObj.onClick = onClick;

            if (!isInIframe) {
                jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
                jsonObj.onContextMenu = onContextMenu;
            }

            // Устанавливаем направление взгляда из hotSpot, если передано
            if (hotSpot) {
                if (hotSpot.point_pitch !== undefined && jsonObj.scenes && jsonObj.scenes.scene1) {
                    jsonObj.scenes.scene1.pitch = hotSpot.point_pitch;
                }
                if (hotSpot.point_yaw !== undefined && jsonObj.scenes && jsonObj.scenes.scene1) {
                    jsonObj.scenes.scene1.yaw = hotSpot.point_yaw;
                }
            }

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = infoValue;
        }
        // Если нет параметров, загружаем изображение по умолчанию
        else {
            var defaultImage = 'img/04.01.2026/DSCN0021.JPG';

            let jsonObj = {
                "hotSpotDebug": false,
                "hotPointDebug": false,
                "sceneFadeDuration": isInIframe ? 500 : 1000,
                "default": {
                    "firstScene": "scene1"
                },
                "scenes": {
                    "scene1": {
                        "title": "Default Panorama",
                        "panorama": defaultImage,
                        "crossOrigin": "use-credentials",
                        "autoLoad": true,
                        "yaw": (hotSpot && hotSpot.point_yaw !== undefined) ? hotSpot.point_yaw : -6.77,
                        "pitch": (hotSpot && hotSpot.point_pitch !== undefined) ? hotSpot.point_pitch : -24.41,
                        "hotSpots": []
                    }
                }
            };
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = isInIframe ? null : onDblClick;
            jsonObj.onClick = onClick;

            if (!isInIframe) {
                jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
                jsonObj.onContextMenu = onContextMenu;
            }

            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = 'default';
        }
    }

    // Функция для загрузки hotspots из JSON файла
    async function loadHotSpotsFromJson(jsonUrl) {
        try {
            const response = await fetch(jsonUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                },
                cache: 'force-cache' // Используем кэш для производительности
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const hotspots = await response.json();

            // Проверяем, является ли результат массивом
            if (Array.isArray(hotspots)) {
                return hotspots;
            } else if (hotspots.hotSpots && Array.isArray(hotspots.hotSpots)) {
                return hotspots.hotSpots;
            } else if (hotspots.scenes && hotspots.scenes.scene1 && hotspots.scenes.scene1.hotSpots) {
                return hotspots.scenes.scene1.hotSpots;
            }

            return [];
        } catch (error) {
            console.log("Error loading JSON hotspots:", error);
            return [];
        }
    }

    function onDblClick(hs) {
        console.log("onDblClick", hs);
        // Только для отладки, не в iframe
        if (!isInIframe && hs) {
            var text = `Yaw: ${hs.yaw.toFixed(2)}, Pitch: ${hs.pitch.toFixed(2)}`;
            navigator.clipboard.writeText(text).then(function() {
                console.log('Coordinates copied to clipboard:', text);
            });
        }
    }

    function onClick(hs) {
        console.log("onClick", hs);
    }

    function onClickHotSpot(hs) {
        console.log("onClickHotSpot", hs);

        // Проверяем, есть ли URL для загрузки новой сцены
        if (hs.panorama_url) {
            // Обновляем URL страницы с новыми параметрами
            let currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('photo', hs.panorama_url);
            currentUrl.searchParams.delete('hotSpots');

            // Если в iframe, используем postMessage для уведомления родителя
            if (isInIframe) {
                try {
                    window.parent.postMessage({
                        type: 'pannellum_navigation',
                        url: currentUrl.toString(),
                        hotSpot: hs
                    }, '*');
                } catch(e) {
                    console.log('Cannot post message to parent');
                }
            }

            window.history.pushState({}, '', currentUrl);

            // Загружаем новую сцену
            setSelectPanorama(hs);
            return true;
        }

        // Старая логика для JSON конфигураций
        const jsonName = hs['panorama_url']?.split('/')[4];
        if (jsonName) {
            const name = jsonName.split('.')[0];
            let currentUrl = new URL(window.location.href);
            if (!currentUrl.searchParams.get('info')) {
                currentUrl.searchParams.append('info', hs.panorama_url.split('/')[4]);
            } else {
                currentUrl.searchParams.set('info', hs.panorama_url.split('/')[4]);
            }
            currentUrl.searchParams.delete('hotSpots');

            // Если в iframe, уведомляем родителя
            if (isInIframe) {
                try {
                    window.parent.postMessage({
                        type: 'pannellum_navigation',
                        url: currentUrl.toString(),
                        hotSpot: hs
                    }, '*');
                } catch(e) {
                    console.log('Cannot post message to parent');
                }
            }

            window.history.pushState({}, '', currentUrl);
            let jsonObj = getJsonUrlData(hs['panorama_url']);
            jsonObj.onClickHotSpot = onClickHotSpot;
            jsonObj.onDblClick = isInIframe ? null : onDblClick;
            jsonObj.onClick = onClick;

            if (!isInIframe) {
                jsonObj.onContextMenuHotSpot = onContextMenuHotSpot;
                jsonObj.onContextMenu = onContextMenu;
            }

            jsonObj['pitch'] = hs['point_pitch'];
            jsonObj['yaw'] = hs['point_yaw'];
            if (sceneMain && typeof sceneMain['destroy'] !== 'undefined') {
                sceneMain.destroy();
            }
            sceneMain = pannellum.viewer('canvas', jsonObj);
            currentScene = name;
            return true;
        }
        return false;
    }

    // Вспомогательные функции
    function getJsonUrlData(url, data) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, false);
        xhr.send(data);
        if (xhr.status != 200) {
            console.error(xhr.status + ': ' + xhr.statusText + ' (' + url + ')');
            return {'error': xhr.status + ' : ' + xhr.statusText};
        } else {
            return JSON.parse(xhr.response);
        }
    }

    // Функция для обработки правой кнопки мыши на HotSpot (только не в iframe)
    function onContextMenuHotSpot(coords, screenCoords, event, hotSpot) {
        if (isInIframe) return;

        console.log("Right click on HotSpot:", {
            coords: coords,
            screenCoords: screenCoords,
            hotSpot: hotSpot,
            event: event
        });

        showCustomContextMenu(screenCoords.x, screenCoords.y, {
            type: 'hotspot',
            data: hotSpot,
            coords: coords
        });
    }

    // Функция для обработки правой кнопки мыши на сцене (только не в iframe)
    function onContextMenu(coords, screenCoords, event) {
        if (isInIframe) return;

        console.log("Right click on scene:", {
            coords: coords,
            screenCoords: screenCoords,
            event: event
        });
        showCustomContextMenu(screenCoords.x, screenCoords.y, {
            type: 'scene',
            data: coords,
            screenCoords: screenCoords
        });
    }

    // Вспомогательная функция для показа кастомного контекстного меню (только не в iframe)
    function showCustomContextMenu(x, y, data) {
        if (isInIframe) return;

        var oldMenu = document.getElementById('custom-context-menu');
        if (oldMenu) {
            oldMenu.remove();
        }

        var menu = document.createElement('div');
        menu.id = 'custom-context-menu';
        menu.style.position = 'absolute';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.style.background = 'white';
        menu.style.border = '1px solid #ccc';
        menu.style.boxShadow = '2px 2px 5px rgba(0,0,0,0.2)';
        menu.style.zIndex = '10000';
        menu.style.padding = '5px 0';
        menu.style.minWidth = '150px';

        if (data.type === 'hotspot') {
            menu.innerHTML = `
            <div class="menu-item" onclick="handleHotSpotAction('edit', ${JSON.stringify(data.data).replace(/"/g, '&quot;')})" style="padding: 5px 10px; cursor: pointer;">Edit HotSpot</div>
            <div class="menu-item" onclick="handleHotSpotAction('delete', ${JSON.stringify(data.data).replace(/"/g, '&quot;')})" style="padding: 5px 10px; cursor: pointer;">Delete HotSpot</div>
            <hr style="margin: 5px 0;">
            <div class="menu-item" onclick="copyCoords(${JSON.stringify(data.coords)})" style="padding: 5px 10px; cursor: pointer;">Copy Coordinates</div>
        `;
        } else {
            menu.innerHTML = `
            <div class="menu-item" onclick='addHotSpotAt(${JSON.stringify(data.data)})' style="padding: 5px 10px; cursor: pointer;">Add HotSpot Here</div>
            <div class="menu-item" onclick='copyCoords(${JSON.stringify(data.data)})' style="padding: 5px 10px; cursor: pointer;">Copy Coordinates</div>
            <hr style="margin: 5px 0;">
            <div class="menu-item" onclick='centerView(${JSON.stringify(data.data)})' style="padding: 5px 10px; cursor: pointer;">Center View Here</div>
        `;
        }

        document.body.appendChild(menu);

        setTimeout(function() {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    // Пример обработчиков действий меню (только не в iframe)
    function handleHotSpotAction(action, hotSpot) {
        if (isInIframe) return;
        console.log(action + ' HotSpot:', hotSpot);
        alert(action + ' HotSpot: ' + (hotSpot.text || hotSpot.type));
    }

    function copyCoords(coords) {
        if (isInIframe) return;
        var text = `Yaw: ${coords.yaw.toFixed(2)}, Pitch: ${coords.pitch.toFixed(2)}`;
        navigator.clipboard.writeText(text).then(function() {
            console.log('Coordinates copied to clipboard:', text);
            alert('Coordinates copied: ' + text);
        });
    }

    function addHotSpotAt(coords) {
        if (isInIframe) return;
        console.log('Add HotSpot at:', coords);
        alert('Add HotSpot at: Yaw=' + coords.yaw.toFixed(2) + ', Pitch=' + coords.pitch.toFixed(2));
    }

    function centerView(coords) {
        if (sceneMain) {
            sceneMain.lookAt(coords.pitch, coords.yaw, sceneMain.getHfov(), 500);
        }
    }

    // Обработчик сообщений от родительской страницы
    window.addEventListener('message', function(event) {
        // Проверяем источник сообщения для безопасности
        // if (event.origin !== 'http://expected-origin.com') return;

        if (event.data && event.data.type === 'pannellum_control') {
            switch(event.data.action) {
                case 'loadScene':
                    if (event.data.photo) {
                        let currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('photo', event.data.photo);
                        if (event.data.hotSpots) {
                            currentUrl.searchParams.set('hotSpots', encodeURIComponent(JSON.stringify(event.data.hotSpots)));
                        }
                        window.history.pushState({}, '', currentUrl);
                        setSelectPanorama(event.data.hotSpot || null);
                    }
                    break;
                case 'toggleInfo':
                    toggleIframeInfo();
                    break;
                case 'getState':
                    // Отправляем состояние обратно родителю
                    try {
                        window.parent.postMessage({
                            type: 'pannellum_state',
                            currentScene: currentScene,
                            isLoaded: sceneMain ? sceneMain.isLoaded() : false
                        }, '*');
                    } catch(e) {
                        console.log('Cannot post message to parent');
                    }
                    break;
            }
        }
    });

</script>
</body>
</html>